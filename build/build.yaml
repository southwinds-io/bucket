---
# NOTE: this script requires setting up the RELEASE variable either with -i option or in a parent build file
env:
  REPO_NAME: registry.southwinds.io
  APP_NAME: bucket
  VERSION: ${RELEASE}-${ARTISAN_REF}

functions:
  - name: build
    run:
      - $(build-linux-arm64)
      - $(build-linux-amd64)
      - cp -R ../templates .
      - cp -R ../static .
      - docker buildx build --load --platform linux/arm64 -t ${REPO_NAME}/play/${APP_NAME}:${RELEASE}-arm64 --build-arg VERSION=${VERSION} .
      - docker buildx build --load --platform linux/amd64 -t ${REPO_NAME}/play/${APP_NAME}:${RELEASE}-amd64 --build-arg VERSION=${VERSION} .
      - rm -rf ./templates
      - rm -rf ./static
      - rm -rf ./linux

  - name: build-linux-amd64
    env:
     GOOS: linux
     GOARCH: amd64
    run:
     - go build -trimpath -ldflags="-s -w" -o ${GOOS}/${GOARCH}/${APP_NAME} ../

  - name: build-linux-arm64
    env:
      GOOS: linux
      GOARCH: arm64
    run:
      - go build -trimpath -ldflags="-s -w" -o ${GOOS}/${GOARCH}/${APP_NAME} ../

  - name: test
    description: |
      launch a working container
    run:
      - docker run -itd --name bucket -p 8888:8080 ${REPO_NAME}/${APP_NAME}:latest

  - name: bash
    description: |
      launch a container waiting to exec into for debugging purposes
    run:
      - docker run -itd --name bucket -p 8888:8080 ${REPO_NAME}/${APP_NAME}:latest tail -f /dev/null